---
title: "Depression, HRV, and CAD Pilot Study"
subtitle: "the Emory Cardiovascular Biobank" 
author: 
- Anish Shah, MD^[Department of Medicine, School of Medicine, Emory University]
- Amit Shah, MD, MSCR^[Divison of Cardiology, Department of Medicine, Emory University]
- Alvaro Alonso, MD, PhD^[Department of Epidemiology, Rollins School of Public Health, Emory University]
fontsize: 10pt
output: 
  beamer_presentation:
    colortheme: "beaver"
    slide_level: 3
  latex_engine: xelatex
header-includes:
  - \usepackage{dcolumn}
  - \usepackage{float}
  - \usepackage{graphicx} 
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
always_allow_html: yes
---

```{r setup and script args, global_options, include=FALSE}
# Start time
alpha_time <- Sys.time()

# Knitr options
knitr::opts_chunk$set(
  cache = TRUE,
  warning = FALSE,
  eval = TRUE,
  echo = FALSE,
  include = TRUE,
  message = FALSE,
  dpi = 600,
  dev = "png",
  options("scipen" = 999, "digits" = 3),
  tinytex.verbose = TRUE,
  tidy = FALSE
)

options(xtable.comment = FALSE)
```

```{r load up data, include = FALSE}
# Libraries
source("1_libraries.R")

# Read in the files
source("2a_vivalnk.R")
source("2b_hrv.R")
source("2c_biobank.R")

# Source Tidying
source("3_tidy.R")

# End of process
omega_time <- Sys.time()
cat("Time to load libraries, intake data, and tidy it...")
print(omega_time - alpha_time)
```

# Overview

### Disclosures and Funding

- Emory University
- Emory Clinical Cardiovascular Research Institute
- Emory Program in Cardivascular Outcomes Research and Epidemiology
- Georgia Clinical & Translational Science Alliance
- NIH/NCATS UL1TR002378, TL1 TL1TR002382

### Emory Cardiovascular Biobank

- Ongoing prospective cohort of patients undergoing cardiac catherization
- Includes clinical history and biomarkers
- Includes psychological questionnaires (including depression by PHQ9)
- Over 7000 patients enrolled thus far

### Background

This is a pilot study examining the relationship between depression and CAD. We have shown using the non-linear HRV metric, Dyx, is a powerful predictor of CAD, and can also be a useful marker for Depression.


### Aims

1. Quantify how depression affects ANS function
2. Examine how HRV can predict obstructive (versus microvascular) CAD

# Descriptive analysis

## Population

### Demographic description

```{r demographics, results = "asis"}
df <- demo
df$adm_reason <- df_txt$adm_reason
df$gend <- df_txt$gend
df$race <- df_txt$race
df$setting <- df_txt$setting


# Table 1
compareGroups(setting ~ gend + race + blbmi + adm_reason, data = df) %>%
  createTable(., hide = c(gend = "Female"), show.p.overall = FALSE) %>%
  export2md(., format = "latex", size = 8, caption = "Depression")
```

## Depression

### Depression scoring

- Each patient is given a questionnaire, the PHQ9
- The scores are validated and suggest severity/category of depression
- Scores >= 10 are considered moderate to severe depression, and accepted cut-off

### Depression table

```{r depression scoring}
df <- inner_join(demo, psych, by = "patid")
df$adm_reason <- df_txt$adm_reason
df$gend <- df_txt$gend
df$race <- df_txt$race
df$sad %<>% factor()
levels(df$sad) <- c("Low Depression", "High Depression")

# Depression comparison
compareGroups(data = df, sad ~ gend + race + adm_reason) %>%
  createTable(., hide = c(gend = "Female"), show.p.overall = FALSE) %>%
  export2md(., format = "latex", size = 8, caption = "Depression scoring")
```

## Coronary artery disease

### Cardiac catherization

- Every patient presents for cardiac catherization to be enrolled
- Are either inpatient or outpatient
- Etiology: pre-op, heart transplant, UA, NSTEMI, STEMI, positive stress test
- scored by angiographic severity indices - CASS and Gensini scores

### CAD Severity

```{r CAD overview}
df <- inner_join(demo, angio_scores, by = "patid")
df$adm_reason <- df_txt$adm_reason
df$gend <- df_txt$gend
df$race <- df_txt$race

# CAD scoring systems
compareGroups(data = df, ~ cass50 + cass70 + gensini + stenosis) %>%
  createTable(., show.p.overall = FALSE) %>%
  export2md(., format = "latex", size = 8, caption = "CAD Severity Scores")
```

## Heart rate variability

### Overview of HRV

- ECG data was collected using the VivaLNK patch
- this records data for up to 72 hours
- ECG was started the AM of LHC, and continued for several hours after event
- HRV is generated through the Emory HRV Toolbox 
- Frequency domain was log-transformed
- HRV was blocked into averaged 1-hour segments for analysis

### Quality of HRV data

```{r}
df <- hrv_params

# HRV quality
compareGroups(data = df, ~ Duration + PercentNotAnalyzed + PercentLowQualityWind) %>%
  createTable(., show.p.overall = FALSE) %>%
  export2md(., format = "latex", size = 8, caption = "HRV quality")
```

### Overview of all HRV measures {.allowframebreaks}

```{r, descriptive HRV}
df <- hrv_proc %>% na.omit()

# Time domain
compareGroups(data = df, ~ BPM + SDNN + RMSSD + PNN50) %>%
  createTable(., show.p.overall = FALSE) %>%
  export2md(., format = "latex", size = 8, caption = "Time Domain")

# Frequency domain
compareGroups(data = df, ~ HF + LF + VLF + ULF + TP + LFHF) %>%
  createTable(., show.p.overall = FALSE) %>%
  export2md(., format = "latex", size = 8, caption = "Frequency Domain")

# Other measures
compareGroups(data = df, ~ AC + DC + SampEn + ApEn) %>%
  createTable(., show.p.overall = FALSE) %>%
  export2md(., format = "latex", size = 8, caption = "Additional Measures")
```

```{r HRV graphs}
df <- hrv_long
month(df$clock) <- month(today())
day(df$clock) <- day(today())

# Visualize
ggplot(df, aes(x = clock, y = value, color = hrv)) +
  geom_smooth(se = TRUE) +
  scale_x_datetime(date_breaks = "4 hours", date_labels = "%H") +
  facet_wrap(~hrv, scales = "free_y") +
  scale_color_viridis_d() +
  theme_minimal() +
  theme(
    legend.position = "none"
  ) +
  labs(
    title = "HRV",
    x = "Time (hour of day)",
    y = "HRV"
  )

df$clock <- hour(df$clock) + minute(df$clock) / 60
df <- na.omit(df)

# Visualizing all the data will be expensive
# Even reducing to just a few patients may be exhaustingly slow
gTimeHRV <-
  ggplot(df, aes(x = clock, y = values)) +
  facet_wrap(~ hrv, ncol = 2) +
  stat_summary(aes(group = hrv, y = values), fun.data = "mean_cl_normal", geom = "ribbon", alpha = 1 / 5) +
  stat_summary(aes(group = hrv, colour = hrv, y = values), fun.y = mean, geom = "line") +
  labs(
    title = "Heart Rate Variability over 24-hours",
    x = "Time of Day (hours)",
    y = "Mean and standard error of the mean",
    colour = "HRV measures"
  ) +
  scale_colour_viridis_d() + 
  theme_minimal() + 
  theme(
    legend.position = "none"
  ) 
```


# Aim 1: Relationship between Depression and ANS Dysfunction

### Differences in population

```{r basic stats for depression}
df <- inner_join(psych[c("patid", "sad")], hrv_proc, by = "patid")

# Distribution of sadness
tmp <- 
  df %>%
  do(
    HF = ks.test(subset(df, sad == 1)$HF, subset(df, sad == 0)$HF) %>% tidy,
    LF = ks.test(subset(df, sad == 1)$LF, subset(df, sad == 0)$LF) %>% tidy,
    VLF = ks.test(subset(df, sad == 1)$VLF, subset(df, sad == 0)$VLF) %>% tidy,
    ULF = ks.test(subset(df, sad == 1)$ULF, subset(df, sad == 0)$ULF) %>% tidy,
    TP = ks.test(subset(df, sad == 1)$TP, subset(df, sad == 0)$TP) %>% tidy,
    LFHF = ks.test(subset(df, sad == 1)$LFHF, subset(df, sad == 0)$LFHF) %>% tidy,
    AC = ks.test(subset(df, sad == 1)$AC, subset(df, sad == 0)$AC) %>% tidy,
    DC = ks.test(subset(df, sad == 1)$DC, subset(df, sad == 0)$DC) %>% tidy,
    SampEn = ks.test(subset(df, sad == 1)$SampEn, subset(df, sad == 0)$SampEn) %>% tidy,
    ApEn = ks.test(subset(df, sad == 1)$ApEn, subset(df, sad == 0)$ApEn) %>% tidy,
    BPM = ks.test(subset(df, sad == 1)$BPM, subset(df, sad == 0)$BPM) %>% tidy
  ) %>%
  pivot_longer(., cols = names(.), names_to = "hrv", values_to = "ks.test")

basic_stats <- 
  df %>%
  do(
    HF = t.test(HF ~ sad, na.omit(df)) %>% tidy,
    LF = t.test(LF ~ sad, na.omit(df)) %>% tidy,
    VLF = t.test(VLF ~ sad, na.omit(df)) %>% tidy,
    ULF = t.test(ULF ~ sad, na.omit(df)) %>% tidy,
    TP = t.test(TP ~ sad, na.omit(df)) %>% tidy,
    LFHF = t.test(LFHF ~ sad, na.omit(df)) %>% tidy,
    AC = t.test(AC ~ sad, na.omit(df)) %>% tidy,
    DC = t.test(DC ~ sad, na.omit(df)) %>% tidy,
    SampEn = t.test(SampEn ~ sad, na.omit(df)) %>% tidy,
    ApEn = t.test(ApEn ~ sad, na.omit(df)) %>% tidy,
    BPM = t.test(BPM ~ sad, na.omit(df)) %>% tidy
  ) %>%
  pivot_longer(., cols = names(.), names_to = "hrv", values_to = "t.test") %>%
  inner_join(tmp, ., by = "hrv")

# Extract pvalues
basic_stats$ks.stat <- map(basic_stats$ks.test, 1) %>% unlist()
basic_stats$ks.pvalue <- map(basic_stats$ks.test, 2) %>% unlist()
basic_stats$t.stat <- map(basic_stats$t.test, 4) %>% unlist()
basic_stats$t.pvalue <- map(basic_stats$t.test, 5) %>% unlist()

# Present data
kable(basic_stats[c("hrv", "ks.pvalue", "t.pvalue")], booktabs = T)
```

### Hourly differences

```{r circadian depression and T-test}
# Df for visualization
df <-
  hrv_blocks %>%
  pivot_longer(., names_to = "hrv", values_to = "value", -c(patid, hour)) %>%
  inner_join(psych[c("patid", "sad")], ., by = "patid") %>%
  na.omit() %>%
  group_by(sad, hour, hrv) %>%
  dplyr::summarise(mean = mean(value), n = length(value), sd = sd(value), se = sd(value) / sqrt(length(value)))

# Have P values for significant differences handy (not currently working)
#overall_t <-
#  inner_join(subset(psych, !is.na(sad)), hrv_blocks, by = "patid") %>%
#  na.omit() %>%
#  do(
#    NN = t.test(NN ~ sad, data = .)$p.value,
#    SDNN = t.test(SDNN ~ sad, data = .)$p.value,
#    RMSSD = t.test(RMSSD ~ sad, data = .)$p.value,
#    PNN50 = t.test(PNN50 ~ sad, data = .)$p.value,
#    ULF = t.test(ULF ~ sad, data = .)$p.value,
#    VLF = t.test(VLF ~ sad, data = .)$p.value,
#    LF = t.test(LF ~ sad, data = .)$p.value,
#    HF = t.test(HF ~ sad, data = .)$p.value,
#    LFHF = t.test(LFHF ~ sad, data = .)$p.value,
#    TP = t.test(TP ~ sad, data = .)$p.value,
#    AC = t.test(AC ~ sad, data = .)$p.value,
#    DC = t.test(DC ~ sad, data = .)$p.value,
#    SampEn = t.test(SampEn ~ sad, data = .)$p.value,
#    ApEn = t.test(ApEn ~ sad, data = .)$p.value,
#  )
#  gather(variable, value, -hour)
#hourly_t$value <- as.numeric(hourly_t$value)
#
## Visualization of data faceted by HRV and grouped by ischemia
#gCircadianSadness <-
#  ggplot(df, aes(x = factor(hour), colour = sad)) +
#  facet_wrap(~ hrv, scales = "free_y") +
#  geom_point(aes(y = mean), size = 2, position = position_dodge(.3)) +
#  scale_shape_manual(values = c(1, 16)) +
#  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.2, position = position_dodge(.3))
#  theme(panel.border = element_rect(colour = "black", fill = NA)) +
#  labs(
#    title = "Hourly HRV in those with depression",
#    x = "Time in Hours",
#    y = "Normalized HRV [SEM]",
#    colour = "Depression",
#  ) +
#  scale_color_viridis(option = "cividis", discrete = TRUE, begin = .1, end = .9) +
#  theme_minimal() +
#  theme(
#    plot.caption = element_text(hjust = 0),
#    legend.position = "bottom",
#    legend.box = "horizontal"
#  )
```

### Visualizing Differences in HRV by Depresion

```{r HRV x depression plot}
df <- 
  inner_join(hrv_proc, psych[c("patid", "sad")], by = "patid") %>%
  pivot_longer(., names_to = "hrv", values_to = "value", values_drop_na = TRUE, -c(patid, index, clock, sad)) %>%
  na.omit()

month(df$clock) <- month(today())
day(df$clock) <- day(today())

# Visualize
ggplot(df, aes(x = clock, y = value, group = factor(sad), color = factor(sad))) + 
  geom_smooth() + 
  scale_x_datetime(date_breaks = "4 hours", date_labels = "%H") +
  facet_wrap(~hrv, scales = "free_y") +
  scale_color_viridis_d(option = "E") +
  theme_minimal() +
  theme(legend.position = "none") + 
  labs(
    title = "HRV by Depression (sad = yellow)",
    x = "Time (hour of day)",
    y = "HRV"
  )
```

### Measures of association

```{r}
df <- 
  pivot_longer(hrv_first_hour, names_to = "hrv", values_to = "value", -c(patid, hour, index, clock)) %>%
  inner_join(psych, ., by = "patid")

# Visualize "first hour" data
ggplot(df, aes(x = phq, y = value, color = hrv)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~hrv, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    title = "First hour of HRV (before cath) and depression",
    x = "PHQ score",
    y = "HRV"
  )
```


# Aim 2: Relationship between CAD and ANS Dysfunction

### Differences in population

```{r basic stats for CAD}
df <- inner_join(angio_scores, hrv_proc, by = "patid")
df$cad <- ifelse(df$cass50 > 1, 1, 0)

# Distribution of sadness
tmp <- 
  df %>%
  do(
    HF = ks.test(subset(df, cad == 1)$HF, subset(df, cad == 0)$HF) %>% tidy,
    LF = ks.test(subset(df, cad == 1)$LF, subset(df, cad == 0)$LF) %>% tidy,
    VLF = ks.test(subset(df, cad == 1)$VLF, subset(df, cad == 0)$VLF) %>% tidy,
    ULF = ks.test(subset(df, cad == 1)$ULF, subset(df, cad == 0)$ULF) %>% tidy,
    TP = ks.test(subset(df, cad == 1)$TP, subset(df, cad == 0)$TP) %>% tidy,
    LFHF = ks.test(subset(df, cad == 1)$LFHF, subset(df, cad == 0)$LFHF) %>% tidy,
    AC = ks.test(subset(df, cad == 1)$AC, subset(df, cad == 0)$AC) %>% tidy,
    DC = ks.test(subset(df, cad == 1)$DC, subset(df, cad == 0)$DC) %>% tidy,
    SampEn = ks.test(subset(df, cad == 1)$SampEn, subset(df, cad == 0)$SampEn) %>% tidy,
    ApEn = ks.test(subset(df, cad == 1)$ApEn, subset(df, cad == 0)$ApEn) %>% tidy,
    BPM = ks.test(subset(df, cad == 1)$BPM, subset(df, cad == 0)$BPM) %>% tidy
  ) %>%
  pivot_longer(., cols = names(.), names_to = "hrv", values_to = "ks.test")

basic_stats <- 
  df %>%
  do(
    HF = t.test(HF ~ cad, na.omit(df)) %>% tidy,
    LF = t.test(LF ~ cad, na.omit(df)) %>% tidy,
    VLF = t.test(VLF ~ cad, na.omit(df)) %>% tidy,
    ULF = t.test(ULF ~ cad, na.omit(df)) %>% tidy,
    TP = t.test(TP ~ cad, na.omit(df)) %>% tidy,
    LFHF = t.test(LFHF ~ cad, na.omit(df)) %>% tidy,
    AC = t.test(AC ~ cad, na.omit(df)) %>% tidy,
    DC = t.test(DC ~ cad, na.omit(df)) %>% tidy,
    SampEn = t.test(SampEn ~ cad, na.omit(df)) %>% tidy,
    ApEn = t.test(ApEn ~ cad, na.omit(df)) %>% tidy,
    BPM = t.test(BPM ~ cad, na.omit(df)) %>% tidy
  ) %>%
  pivot_longer(., cols = names(.), names_to = "hrv", values_to = "t.test") %>%
  inner_join(tmp, ., by = "hrv")

# Extract pvalues
basic_stats$ks.stat <- map(basic_stats$ks.test, 1) %>% unlist()
basic_stats$ks.pvalue <- map(basic_stats$ks.test, 2) %>% unlist()
basic_stats$t.stat <- map(basic_stats$t.test, 4) %>% unlist()
basic_stats$t.pvalue <- map(basic_stats$t.test, 5) %>% unlist()

# Present data
kable(basic_stats[c("hrv", "ks.pvalue", "t.pvalue")], booktabs = T)
```

### Visualizing Differences in HRV by CAD

```{r HRV x CAD plot}
df <- inner_join(hrv_proc, angio_scores[c("patid", "stenosis", "cass50")], by = "patid")
df$cad <- ifelse(df$cass50 > 1, 1, 0)

df %<>%
  pivot_longer(., names_to = "hrv", values_to = "value", values_drop_na = TRUE, -c(patid, index, clock, stenosis, cad, cass50)) %>% 
  na.omit()

month(df$clock) <- month(today())
day(df$clock) <- day(today())

# Visualize
ggplot(df, aes(x = clock, y = value, group = factor(cad), color = factor(cad))) + 
  geom_smooth(na.rm = TRUE) +
  scale_x_datetime(date_breaks = "4 hours", date_labels = "%H") +
  facet_wrap(~hrv, scales = "free_y") +
  scale_color_viridis_d(option = "E") +
  theme_minimal() +
  theme(legend.position = "none") + 
  labs(
    title = "HRV by CASS50 (if >1 = yellow)",
    x = "Time (hour of day)",
    y = "HRV"
  )
```

### Hourly differences {.allowframebreaks}

```{r, circadian CAD}
# Df for visualization
tmp <- angio_scores
tmp$cad <- ifelse(tmp$cass50 > 1, 1, 0)

df <- 
  hrv_blocks %>%
  pivot_longer(., names_to = "hrv", values_to = "value", -c(patid, hour)) %>%
  inner_join(tmp[c("patid", "cad")], ., by = "patid") %>%
  na.omit() %>%
  group_by(hour, hrv, cad) %>%
  dplyr::summarise(mean = mean(value), n = length(value), sd = sd(value), se = sd(value) / sqrt(length(value)))


df <- 
  inner_join(tmp, hrv_blocks, by = "patid") %>%
  na.omit() %>%
  group_by(hour) %>%
  do(
    NN = tidy(t.test(NN ~ cad, data = .)),
    SDNN = tidy(t.test(SDNN ~ cad, data = .)),
    RMSSD = tidy(t.test(RMSSD ~ cad, data = .)),
    PNN50 = tidy(t.test(PNN50 ~ cad, data = .)),
    ULF = tidy(t.test(ULF ~ cad, data = .)),
#    VLF = tidy(t.test(VLF ~ cad, data = .)),
#    LF = tidy(t.test(LF ~ cad, data = .)),
#    HF = tidy(t.test(HF ~ cad, data = .)),
    LFHF = tidy(t.test(LFHF ~ cad, data = .)),
#    TP = tidy(t.test(TP ~ cad, data = .)),
    AC = tidy(t.test(AC ~ cad, data = .)),
    DC = tidy(t.test(DC ~ cad, data = .)),
    SampEn = tidy(t.test(SampEn ~ cad, data = .)),
    ApEn = tidy(t.test(ApEn ~ cad, data = .))
    )

# Visualization of data faceted by HRV and grouped by ischemia
tmp <-
  ggplot(df, aes(x = factor(hour), colour = stenosis)) +
  facet_wrap(~ hrv, scales = "free_y") +
  geom_point(aes(y = mean), size = 2, position = position_dodge(.3)) +
  scale_shape_manual(values = c(1, 16)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.2, position = position_dodge(.3)) +
  theme(panel.border = element_rect(colour = "black", fill = NA)) +
  labs(
    title = "Hourly HRV in those with CAD",
    x = "Time in Hours",
    y = "Normalized HRV [SEM]",
    colour = "CAD"
  ) +
  scale_color_viridis(option = "cividis", discrete = TRUE, begin = .1, end = .9) +
  theme_minimal()
```

```{r}
df <- inner_join(hrv_blocks, angio_scores, by = "patid")
df$cad <- ifelse(df$cass50 > 1, 1, 0)

```

### Measing association

```{r}
df <- 
  pivot_longer(hrv_proc, names_to = "hrv", values_to = "value", -c(patid, index, index, clock)) %>%
  inner_join(angio_scores, ., by = "patid") %>%
  na.omit()
df$cad <- ifelse(df$cass50 > 1, 1, 0)

# Visualize "first hour" data
ggplot(df, aes(x = value, y = cad, color = hrv)) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial")) +
  facet_wrap(~hrv, scales = "free_x") +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    title = "Does HRV Classify patients with CAD?",
    x = "HRV",
    y = "CAD"
  )

# REgrsssions
df <- inner_join(hrv_proc, angio_scores, by = "patid") %>% na.omit()
df$cad <- ifelse(df$cass50 > 1, 1, 0)
df$hour <- hour(df$clock)

glm(cad ~ LF*hour, family = "binomial", data = df) %>% summary()
```
