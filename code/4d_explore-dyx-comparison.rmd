---
title: "Depression, HRV, and CAD Pilot Study"
subtitle: "Comparison of RR Peak Detection Methods and Dyx"
author:
- Anish Shah, MD^[Department of Medicine, School of Medicine, Emory University]
- Amit Shah, MD, MSCR^[Divison of Cardiology, Department of Medicine, Emory University]
- Alvaro Alonso, MD, PhD^[Department of Epidemiology, Rollins School of Public Health,
  Emory University]
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  beamer_presentation:
    citation_package: natbib
    colortheme: seahorse
    latex_engine: xelatex
    slide_level: 3
    theme: default
link-citations: yes
classoption: unknownkeysallowed
csl: ../../bibliography/apa.csl
bibliography: ../../bibliography/Neurocardiology.bib
fontsize: 10pt
header-includes:
- \usepackage{dcolumn}
- \usepackage{float}
- \usepackage{graphicx}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
always_allow_html: yes
---

```{r global_options, include=FALSE}

# Knitr options
knitr::opts_chunk$set(
  cache = TRUE,
  warning = FALSE,
  eval = TRUE,
  echo = FALSE,
  include = TRUE,
  message = FALSE,
  dpi = 600,
  dev = "png",
  options("scipen" = 999, "digits" = 3),
  tinytex.verbose = TRUE,
  tidy = FALSE
)

options(xtable.comment = FALSE)

# Needed libraries
library(tidyverse)
library(tidymodels)
library(readxl)
library(autonomicR)
library(janitor)
library(lubridate)
library(lme4)
library(kableExtra)
library(infer)
```

# Overview

### Background

- _Dyx_ is seen to be a potentially powerful marker for ANS dysfunction [@Shah2020]
- Generated by the ratio of kurtosis of x-axis to y-axis on Poincare plot
- Why is it more robust then other HRV measures at signaling ANS dysfunction?
  - Potentially due to capturing ectopy and the SA response to ectopy
  
### Approach

1. Compare HRV toolbox output for RR intervals using conservative and relaxed definitions for R-peak detection [@Vest2018]
2. Generate _Dyx_ values for both types of methods
3. Compare findings

Relaxed definitions decrease the threshold needed for R peak detection, discard less __unusuable windows__, and limits interpolation of data, and allows for more ectopic beats (broadened definitions for _unphysiologic beats_).

# _Dyx_ Comparison

### Conservative approach {.shrink}

```{r}
# Data
df <- read_xlsx("../data/HeartTrends/dyx_data-12-01-20.xlsx") %>%
  clean_names()
names(df)[1] <- "sequence"
vivalnk <- read_csv("../data/proc_data/vivalnk_data.csv")

# Old ids
patients <- unique(gsub("_rr", "", df$patient_id))

# Setup
rec <-
  recipe( ~ patient_id + final_dyx + sequence, data = df) %>%
  step_mutate(patient_id = gsub("_rr", "", patient_id)) %>%
  step_rename(dyx = final_dyx, index = sequence, patid = patient_id) %>%
  step_filter(patid %in% patients) %>%
  prep()

# Old data
old <- bake(rec, df)

# Add in start time
old <- left_join(old, vivalnk, by = "patid")
old$clock <- old$Start + hours(old$index - 1)

# Summary
old$dummy <- 1
old$hour <- hour(old$clock)
tbl <- circ_compare_groups(old, x = "dyx", y = "dummy", time = "hour")

ggplot(tbl) +
  geom_circadian(time = "hour", group = "dummy", pval = FALSE) +
  labs(
    x = "Time of Day in Hours",
    y = "Dyx [SE]",
    title = "Conservative DYX Values"
  )
```

### Relaxed approach

```{r}
# Data
df <- read_xlsx("../data/HeartTrends/dyx_data-04-20-20.xlsx") %>%
  clean_names()

# Prep and bake
new <- bake(rec, df)

# Add in start time
new <- left_join(new, vivalnk, by = "patid")
new$clock <- new$Start + hours(new$index - 1)

# Summary
new$dummy <- 1
new$hour <- hour(new$clock)
tbl <- circ_compare_groups(new, "dyx", "dummy", "hour")
ggplot(tbl) +
  geom_circadian(time = "hour", group = "dummy", pval = FALSE) +
  labs(
    x = "Time of Day in Hours",
    y = "Dyx [SE]",
    title = "Relaxed DYX Values"
  )
```

### Comparison of _Dyx_ measures {.shrink}

```{r}
new$type <- "new"
old$type <- "old"
both <- bind_rows(old, new)

# Comparison
tbl <- circ_compare_groups(both, "dyx", "type", "hour")
ggplot(tbl) +
  geom_circadian(time = "hour", group = "type", pval = FALSE) +
  labs(
    x = "Time of Day in Hours",
    y = "Dyx [SE]",
    title = "Comparison of Dyx by R-Peak Detection Rigor"
  )
```

### Statistical approach {.shrink}

```{r first look}
# data
wide <-
  full_join(old[c("patid", "dyx", "hour")],
            new[c("patid", "dyx", "hour")],
            by = c("patid", "hour"),
            suffix = c(".con", ".rel"))

shorty <-
  wide %>%
  group_by(patid) %>%
  mutate(dyx.con = mean(dyx.con, na.rm = TRUE),
         dyx.rel = mean(dyx.rel, na.rm = TRUE)) %>%
  subset(select = -hour) %>%
  unique() %>%
  mutate(dyx = dyx.rel - dyx.con)

shorty %>%
  t_test(response = dyx) %>%
  kable(format = "latex", caption = "Paired t-test by patient", booktabs = TRUE) %>%
  kable_styling(latex_options = "HOLD_position")
```

```{r second look}
shorter <-
  wide %>%
  group_by(hour) %>%
  mutate(dyx.con = mean(dyx.con, na.rm = TRUE),
         dyx.rel = mean(dyx.rel, na.rm = TRUE)) %>%
  subset(select = -patid) %>%
  unique() %>%
  mutate(dyx = dyx.rel - dyx.con)

shorter %>%
  t_test(response = dyx) %>%
  kable(format = "latex", caption = "Paired t-test by hour", booktabs = TRUE) %>%
  kable_styling(latex_options = "HOLD_position")
```

# Conclusion

- Comparison of original 30 patients with "conservative" HRV generation and the "relaxed" HRV generation
- _Dyx_ is slightly higher in the relaxed compared to conservative settings
- No statistical significant difference in methods (issues of power however)

# References {.fragile}
